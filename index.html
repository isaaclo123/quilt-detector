<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quilt Patch Viewer (Bigger Desktop Modal, Scaled Images)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html, body {
          height: 100%; width: 100vw; margin: 0; padding: 0; background: #222;
a {
  color: #F48FB1;
  text-decoration: underline;
}
a:hover, a:focus {
  text-decoration: underline;
  color: #F48FB1;
}
          font-family: 'Merriweather', serif; overflow: hidden;
    }
    .quilt-wrap {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: #222; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    #quilt-bg {
      display: block;
      max-width: 98vw; max-height: 98vh; width: auto; height: auto;
      object-fit: contain; background: #222;
      position: absolute; user-select: none; pointer-events: none; z-index: 1; left: 0; top: 0;
    }
    #patch-rects {
      position: absolute; left: 0; top: 0; pointer-events: none; z-index: 10;
      width: 0; height: 0; overflow: visible;
    }
    .patch-rect {
      fill: rgba(0,0,0,0);
      pointer-events: all;
      cursor: pointer;
      transition: stroke-width 0.19s, stroke 0.22s, fill 0.16s, filter 0.28s;
      filter: drop-shadow(0px 0px 0px rgba(227,122,0,0));
    }
    .patch-rect.active,
    .patch-rect:focus,
    .patch-rect:hover {
      stroke: #ffbcc8; stroke-width: 5px; fill: rgba(255,188,200,0.14);
            filter: drop-shadow(0 2.5px 14px rgba(255,209,231,0.25));
      z-index: 20;
    }
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.62);
      z-index: 9999; align-items: center; justify-content: center; opacity: 0;
      pointer-events: none;
      transition: opacity 0.33s cubic-bezier(.48,1,.1,.94);
    }
    .modal-backdrop.active {
      display: flex; opacity: 1; pointer-events: auto;
      align-items: center; justify-content: center;
      transition: opacity 0.44s cubic-bezier(.45,0,.1,1.1);
    }
    .global-modal-close {
      position: fixed;
      top: 1.5vw; right: 2vw;
      background: transparent;
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
      font-size: 2.4em;
      color: #ffbcc8;
      cursor: pointer;
      border-radius: 100px;
      line-height:1.1;
      z-index: 12000; padding: 0 0.15em;
      font-weight: bold; transition: background 0.14s, color 0.14s;
      display: none;
    }
    .modal-backdrop.active ~ .global-modal-close {
      display: block;
    }
    .global-modal-close:hover, .global-modal-close:focus { background: transparent; color: #ffbcc8; outline: none;}
    .modal-arrows-static {
      position: fixed;
      pointer-events: none;
      z-index: 10000;
      top: 50%;
      left: 0; width: 100vw; height: 0;
      display: flex; align-items: center; justify-content: space-between;
    }
    /* Modal navigation arrow buttons: Default (transparent), hover/focus get pink background + accent, no border/shadow on normal */
    .modal-caret {
      background: transparent !important;
      border: none;
      font-size: 2.4em;
      color: #ffbcc8;
      cursor: pointer;
      border-radius: 100px;
      width: 1.5em;
      height: 1.5em;
      min-width: 1.2em;
      min-height: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 24;
      pointer-events: auto;
      transition: background 0.14s, color 0.14s;
      margin: 0 1vw;
      box-shadow: none !important;
      position: relative;
      user-select: none;
    }
    .modal-caret svg {
      width: 1em;
      height: 1em;
      display: block;
    }
    @media (max-width: 700px) {
      .modal-caret {
        font-size: 1.05em;
        width: 1.18em;
        height: 1.18em;
        min-width: 1em;
        min-height: 1em;
      }
      .modal-caret svg {
        width: 0.8em;
        height: 0.8em;
      }
    }
    
        .modal-caret:hover, .modal-caret:focus, .modal-caret:active {
              background: transparent !important;
              outline: none;
              /* Highlight the triangle fill color (SVG) visually on hover/focus */
            }
            .modal-caret:hover svg polygon, .modal-caret:focus svg polygon, .modal-caret:active svg polygon {
              fill: #f49cbb;
              filter: drop-shadow(0 0 4px #ffbcc7cc);
    }
    .modal-content-wrap {
      position: relative; width: 0; height: 0; display: flex; align-items: center; justify-content: center;
    }
    .modal-content-anim {
      position: absolute; left: 50%; top: 50%;
      background: #fff; box-shadow: 0 8px 40px #000a; border-radius: 12px;
      padding: 1.9em 1.5em 1.5em 1.5em;
      min-width: 260px; min-height: 270px;
          max-width: 90vw; max-height: 90vh;
          width: auto;
          box-sizing: border-box;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          overflow: hidden;
      will-change: transform, opacity;
      transition:
        transform 0.47s cubic-bezier(.85,.26,.16,1.34),
        opacity 0.37s cubic-bezier(.5,.4,.18,1.0);
      opacity: 1;
      transform: translate(-50%,-50%);
    }
    .modal-content-anim.modal-fadein {
      opacity: 0;
      animation: modal-fadein 0.32s ease-out forwards;
    }
    .modal-content-anim.modal-fadeout {
      opacity: 1;
      animation: modal-fadeout 0.32s ease-in forwards;
    }
    @keyframes modal-fadein { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modal-fadeout { from { opacity: 1; } to { opacity: 0; } }
    .modal-label {
      order: 0;
      font-size: 1.55em; color: #F48FB1; font-weight: bold;
      margin-bottom: 0.7em; margin-top: 0em; text-align: center;
      padding-left: 0; padding-right: 0;
      width: 100%; max-width: 100%; background: #fff; box-sizing: border-box; word-break: break-word;
      flex: 0 0 auto;
    }
    .modal-desc {
      order: 2;
      font-size: 1.1em; color: #322; text-align: center;
      margin: 0.52em 0 0.52em 0;
      max-width: 94vw; line-height: 1.5; background: #fff; word-break: break-word;
      width: 100%; box-sizing: border-box;
      flex: 0 0 auto;
    }
    .modal-slideshow {
      order: 1;
      position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-direction: column;
          flex: 1 1 auto;
          width: 100%;
          height: 100%;
          margin: 0 0 .6em 0;
          background: none !important; box-shadow: none !important;
          min-width: 150px;
          min-height: 120px;
    }
    .modal-slide-img {
          display: block;
          margin: 0 auto;
              width: auto;
              height: auto;
              max-width: 100%;
              max-height: 100%;
              object-fit: contain;
          min-width: 33vw !important;
          border: none !important; background: none !important; box-shadow: none !important;
          z-index: 10;
          box-sizing: border-box;
    }
    .spinner {
      display: flex;
      width: 100%;
      flex: 1 1 auto;
      align-items: center;
      justify-content: center;
      min-height: 90px;
      min-width: 90px;
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      z-index: 9;
      pointer-events: none;
    }
    .lds-ring { display: inline-block; position: relative; width: 36px; height: 36px; }
    .lds-ring div {
      box-sizing: border-box;
      display: block;
      position: absolute;
      width: 26px;
      height: 26px;
      margin: 4px;
      border: 4px solid #F48FB1;
      border-radius: 50%;
      animation: lds-ring 1.2s cubic-bezier(0.65,0,0.45,1) infinite;
      border-color: #b93 transparent transparent transparent;
    }
    .lds-ring div:nth-child(1) { animation-delay: -0.45s; }
    .lds-ring div:nth-child(2) { animation-delay: -0.3s; }
    .lds-ring div:nth-child(3) { animation-delay: -0.15s; }
    @keyframes lds-ring { 0% { transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    @media (max-width: 700px) {
      .modal-content-anim { min-width: 76px; min-height: 86px; padding: 0.75em 0.5em 0.5em 0.5em; max-width: 99vw; width: auto; }
      .modal-label { font-size: 1.05em; margin-bottom:.75em; margin-top:0.0em;}
      .modal-desc { font-size:0.90em; margin: 0.18em 0 0.18em 0;}
      .modal-arrow { font-size: 1.28em; width: 48px; height: 48px; min-width: 44px; min-height: 44px; padding: 0 6px; }
      .modal-slideshow { max-width: 99vw; min-width: 55vw; min-height: 52px; }
      .modal-slide-img { max-width: 100%; max-height: 21vh; min-width:75vw !important; min-height:21px; box-sizing: border-box; }
      .spinner { min-width: 7vw; min-height: 32px;}
      .lds-ring { width: 19px; height: 19px;}
      .lds-ring div { width: 12px; height: 12px; margin: 2px; border-width: 3px;}
      .global-modal-close { font-size: 1.05em; top:.15em; right:.4em; }
    }
  </style>
</head>
<body>
  <div class="quilt-wrap" id="quiltWrap">
    <img src="quilt-lowres.jpg" id="quilt-bg" alt="Quilt Background">
    <svg id="patch-rects"></svg>
  </div>
  <div class="modal-backdrop" id="modal">
    <div class="modal-arrows-static">
      <span class="modal-caret" id="modalPrev" aria-label="Previous patch" title="Previous patch" tabindex="0" role="button"><svg width="32" height="32" viewBox="0 0 32 32" style="display:inline-block;vertical-align:middle" aria-hidden="true"><polygon points="22,4 10,16 22,28" fill="#ffbcc8"/></svg></span>
            <span class="modal-caret" id="modalNext" aria-label="Next patch" title="Next patch" tabindex="0" role="button"><svg width="32" height="32" viewBox="0 0 32 32" style="display:inline-block;vertical-align:middle" aria-hidden="true"><polygon points="10,4 22,16 10,28" fill="#ffbcc8"/></svg></span>
    </div>
    <div class="modal-content-wrap" id="modalContentWrap"></div>
  </div>
  <button class="global-modal-close" id="modalCloseGlobal" aria-label="Close" style="display:none">&times;</button>
  <script>
    let patches = [];
    const quiltImg = document.getElementById('quilt-bg');
    const patchRects = document.getElementById('patch-rects');
    let modalIdx = 0, animating = false, modalOpen = false, cleanupModalTimeout = null;

    const modal = document.getElementById('modal');
    const modalPrev = document.getElementById('modalPrev');
    const modalNext = document.getElementById('modalNext');
    const modalContentWrap = document.getElementById('modalContentWrap');
    const modalCloseGlobal = document.getElementById('modalCloseGlobal');

    // Extra JS: actively enforce the arrow button normal state after mouse leaves or blur (prevents sticky background)
    [modalPrev, modalNext].forEach(btn => {
      // Robustly force reset on all possible events where highlighting might stick
      function forceReset() {
        setTimeout(() => {
          btn.style.background = 'transparent';
          btn.style.boxShadow = 'none';
        }, 1); // Run after browser state, avoids race with :active
      }
      btn.addEventListener('mouseleave', forceReset);
      btn.addEventListener('mouseout', forceReset);
      btn.addEventListener('blur', forceReset);
      btn.addEventListener('mouseup', forceReset);
      // Defensive: keyup should also reset if any browser sticks focus
      btn.addEventListener('keyup', function(e) {
        if (e.key === 'Tab' || e.key === 'Enter' || e.key === 'Escape' || e.key === ' ') forceReset();
      });
    });

    function drawPatchRects() {
      if (!quiltImg.complete || !quiltImg.naturalWidth || !quiltImg.naturalHeight) return;
      const viewportW = window.innerWidth, viewportH = window.innerHeight;
      const imgNatW = quiltImg.naturalWidth, imgNatH = quiltImg.naturalHeight;
      const ratio = Math.min(0.98 * viewportW / imgNatW, 0.98 * viewportH / imgNatH);
      const displayW = imgNatW * ratio, displayH = imgNatH * ratio;
      const offsetX = (viewportW - displayW) / 2;
      const offsetY = (viewportH - displayH) / 2;
      quiltImg.style.width = displayW + "px";
      quiltImg.style.height = displayH + "px";
      quiltImg.style.left = offsetX + "px";
      quiltImg.style.top = offsetY + "px";
      quiltImg.style.position = "absolute";
      patchRects.setAttribute('width', displayW);
      patchRects.setAttribute('height', displayH);
      patchRects.style.width = displayW + 'px';
      patchRects.style.height = displayH + 'px';
      patchRects.style.left = offsetX + 'px';
      patchRects.style.top  = offsetY + 'px';
      patchRects.setAttribute('viewBox', `0 0 ${displayW} ${displayH}`);
      patchRects.innerHTML = "";
      const scaleX = displayW / imgNatW;
      const scaleY = displayH / imgNatH;
      patches.forEach((p, idx) => {
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('class','patch-rect');
        rect.setAttribute('x', p.left   * scaleX);
        rect.setAttribute('y', p.top    * scaleY);
        rect.setAttribute('width', p.width  * scaleX);
        rect.setAttribute('height',p.height * scaleY);
        rect.setAttribute('tabindex',0);
        rect.setAttribute('data-idx',idx);
        rect.addEventListener('mouseover', ()=>{ rect.classList.add('active'); });
        rect.addEventListener('mouseout',  ()=>{ rect.classList.remove('active'); });
        rect.addEventListener('focus',     ()=>{ rect.classList.add('active'); });
        rect.addEventListener('blur',      ()=>{ rect.classList.remove('active'); });
        rect.addEventListener('click', (e)=>{
          openModal(idx);
          e.stopPropagation();
        });
        patchRects.appendChild(rect);
      });
    }

    function openModal(idx) {
      if (cleanupModalTimeout) { clearTimeout(cleanupModalTimeout); cleanupModalTimeout = null; }
      document.querySelectorAll('.patch-rect').forEach(el => {
        el.classList.remove('active'); el.blur();
      });
      modalIdx = (idx + patches.length) % patches.length;
      renderModal(modalIdx, null, true);
      modalOpen = true;
      modal.classList.add('active');
      modalCloseGlobal.style.display = "block";
    }

    function slideToModal(newIdx, direction) {
      if (animating || newIdx === modalIdx) return;
      renderModal(newIdx, direction, false);
      modalIdx = (newIdx + patches.length) % patches.length;
    }

    function closeModal() {
      document.querySelectorAll('.patch-rect').forEach(el => el.blur());
      if (cleanupModalTimeout) clearTimeout(cleanupModalTimeout);
      const card = modalContentWrap.querySelector('.modal-content-anim');
      if(card) {
        card.classList.remove('modal-fadein');
        card.classList.add('modal-fadeout');
      }
      modal.classList.remove('active');
      modalCloseGlobal.style.display = "none";
      modalOpen = false;
      cleanupModalTimeout = setTimeout(()=>{
        if(card && card.parentNode) card.parentNode.removeChild(card);
        modalContentWrap.innerHTML = '';
        cleanupModalTimeout = null;
      },340);
    }

    modalCloseGlobal.onclick = closeModal;

    function createSpinner() {
      const spinner = document.createElement('div');
      spinner.className = 'spinner';
      spinner.innerHTML = `<div class="lds-ring"><div></div><div></div><div></div><div></div></div>`;
      return spinner;
    }

    function renderModal(idx, direction = null, isEnter = true) {
      if (animating) return;
      idx = (idx + patches.length) % patches.length;
      const p = patches[idx];
      const prevCard = modalContentWrap.querySelector('.modal-content-anim');
      // FLEX LAYOUT: label at top (order:0), slideshow mid (order:1, flex:1), desc at bottom (order:2)
      const card = document.createElement('div');
      card.className = 'modal-content-anim';
      card.innerHTML = `
        <div class="modal-label">${p.label ? p.label : `Patch ${idx+1}`}</div>
        <div class="modal-slideshow"></div>
        <div class="modal-desc">${p.desc ? p.desc : ''}</div>
      `;
      const slideDiv = card.querySelector('.modal-slideshow');
      const spinner = createSpinner();
      slideDiv.appendChild(spinner);

      if (p.filename) {
        const imgEl = document.createElement('img');
        imgEl.className = "modal-slide-img";
        imgEl.alt = p.label || '';
        imgEl.src = "thumbnails/" + p.filename;

        // Always stretch images to fill modal slideshow area (width 100%, height auto)
        imgEl.style.opacity = '0';
        imgEl.style.width = "100%";
        imgEl.style.height = "auto";
        imgEl.style.minWidth = "110px";
        imgEl.style.minHeight = "90px";
        imgEl.style.maxWidth = "97vw";
        imgEl.style.maxHeight = "43vh";
        imgEl.onload = function() {
          spinner.style.display = 'none';
          imgEl.style.opacity = '1';
        };
        imgEl.onerror = function() {
          spinner.style.display = 'none';
          imgEl.style.background = "#e86e6e";
          imgEl.alt = "(thumbnail image not found)";
        };
        slideDiv.appendChild(imgEl);
      } else {
        spinner.style.display = 'none';
        slideDiv.innerHTML += '<div style="color:#902; background:#fee; padding:.5em; border-radius:5px;">No patch thumbnail (filename) set in JSON for this patch.</div>';
      }
      card.style.opacity = "1";
      let startTransform = "translate(-50%,-50%)";
      let endTransform = "translate(-50%,-50%)";
      if (direction === 'left')      startTransform = "translate(80vw,-50%)";
      else if (direction === 'right')startTransform = "translate(-180vw,-50%)";
      card.style.transform = startTransform;
      if (prevCard) prevCard.style.zIndex = "2";
      card.style.zIndex = "3";
      modalContentWrap.appendChild(card);

      setTimeout(() => {
        const lab = card.querySelector('.modal-label');
        if (lab) lab.focus && lab.focus();
      }, 350);

      if (isEnter || !prevCard) {
        card.classList.add('modal-fadein');
        if (prevCard && prevCard.parentNode)
          prevCard.parentNode.removeChild(prevCard);
      } else if (direction && prevCard) {
        animating = true;
        prevCard.style.transition = "transform 0.47s cubic-bezier(.85,.26,.16,1.34), opacity 0.37s cubic-bezier(.5,.4,.18,1.0)";
        if (direction === "left") prevCard.style.transform = "translate(-180vw,-50%)";
        else if (direction === "right") prevCard.style.transform = "translate(80vw,-50%)";
        prevCard.style.opacity = "0.6";
        setTimeout(() => {
          card.style.transition = "transform 0.47s cubic-bezier(.85,.26,.16,1.34), opacity 0.37s cubic-bezier(.5,.4,.18,1.0)";
          card.style.transform = endTransform;
        }, 10);
        setTimeout(() => {
          if (prevCard.parentNode) prevCard.parentNode.removeChild(prevCard);
          animating = false;
        }, 480);
      } else {
        if (prevCard && prevCard.parentNode)
          prevCard.parentNode.removeChild(prevCard);
        card.style.transition = "none";
        card.style.transform = endTransform;
      }
    }

    modalPrev.addEventListener('click', ()=>{
      if(!modalOpen || animating) return;
      slideToModal((modalIdx-1+patches.length) % patches.length, 'right');
    });
    modalNext.addEventListener('click', ()=>{
      if(!modalOpen || animating) return;
      slideToModal((modalIdx+1) % patches.length, 'left');
    });

    window.addEventListener('keydown', e => {
      if(modalOpen && modal.classList.contains('active') && !animating) {
        if(e.key==="Escape"||e.key==="Esc"){ closeModal(); }
        else if(e.key==="ArrowLeft"||e.key==="Left"){ slideToModal((modalIdx-1+patches.length)%patches.length,'right'); }
        else if(e.key==="ArrowRight"||e.key==="Right"){ slideToModal((modalIdx+1)%patches.length,'left'); }
      }
    });

    ['touchstart','mousedown'].forEach(evt => {
      modal.addEventListener(evt, function(e){
        if(modal.classList.contains('active') && e.target === modal) {
          closeModal();
          e.stopPropagation();
          e.preventDefault();
        }
      }, {capture: false});
    });

    window.addEventListener('resize', ()=>{
      if(quiltImg.complete && patches.length) drawPatchRects();
      if(modalOpen && modal.classList.contains('active')) renderModal(modalIdx,null);
    });
    quiltImg.onload = ()=>{
      if(patches.length) drawPatchRects();
    };

    // Load patches from file
    fetch('quilt-patches.json')
      .then(r=>r.json())
      .then(json=>{
        patches = Array.isArray(json) ? json : json.patches;
        if (quiltImg.complete) drawPatchRects();
      });
  </script>
</body>
</html>
